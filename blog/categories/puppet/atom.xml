<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: puppet | service rhysd reload]]></title>
  <link href="http://rhysd.co.nz/blog/categories/puppet/atom.xml" rel="self"/>
  <link href="http://rhysd.co.nz/"/>
  <updated>2013-06-21T13:30:45+12:00</updated>
  <id>http://rhysd.co.nz/</id>
  <author>
    <name><![CDATA[Rhys Davies]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Puppet client setup script]]></title>
    <link href="http://rhysd.co.nz/blog/2013/06/21/puppet-client-setup-script/"/>
    <updated>2013-06-21T12:26:00+12:00</updated>
    <id>http://rhysd.co.nz/blog/2013/06/21/puppet-client-setup-script</id>
    <content type="html"><![CDATA[<p>Simple but useful script for setting up puppet on client machines</p>

<!-- more -->


<p><div><script src='https://gist.github.com/5827861.js?file=puppet_client'></script>
<noscript><pre><code>#!/bin/bash

if [ $# == 0 ] ; then
cat &lt;&lt;EOF
Usage: $0 DIST (wheezy,squeeze,lucid) FQDN

EOF
  exit 2
fi

DIST=$1
FQDN=$2
INSTALLED=$(dpkg-query -W --showformat='${Status}\n' puppet | grep &quot;install ok installed&quot;)

if [ &quot;xxx&quot; == &quot;$DIST&quot;&quot;xxx&quot; ];then
 echo Please enter distribution
 exit 1
fi

if [ &quot;xxx&quot; == &quot;$FQDN&quot;&quot;xxx&quot; ]; then
 echo Please enter puppet master fqdn
 exit 1
fi

if [ &quot;xxx&quot; == &quot;$INSTALLED&quot;&quot;xxx&quot; ]; then
  wget http://apt.puppetlabs.com/puppetlabs-release-$DIST.deb
  dpkg -i puppetlabs-release-$DIST.deb
  apt-get update
  apt-get install puppet
  cat - &gt; /etc/puppet/puppet.conf &lt;&lt;EOF
[main]
logdir=/var/log/puppet
vardir=/var/lib/puppet
ssldir=/var/lib/puppet/ssl
rundir=/var/run/puppet
factpath=$vardir/lib/facter
templatedir=$confdir/templates
server=$FQDN
EOF

 else
   echo &quot;Puppet already installed&quot;
fi</code></pre></noscript></div>
</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Generating config with hashes in puppet]]></title>
    <link href="http://rhysd.co.nz/blog/2013/06/19/generating-config-with-hashes-in-puppet/"/>
    <updated>2013-06-19T20:32:00+12:00</updated>
    <id>http://rhysd.co.nz/blog/2013/06/19/generating-config-with-hashes-in-puppet</id>
    <content type="html"><![CDATA[<p>Playing around with puppet today (as always) and stumbled across a sweet pattern in a couple of modules for creating config files from hashes. Particularly good for building overriding config.</p>

<!-- more -->


<p>So here is the template</p>

<p>``` bash mysql.d.cnf.erb</p>

<h3>MANAGED BY PUPPET</h3>

<p>&lt;% @settings.sort.each do |section, content|      &ndash;%>
[&lt;%= section %>]
&lt;%   content.sort.each do |key, values|          &ndash;%>
&lt;%     [values].flatten.sort.each do |value|     &ndash;%>
&lt;%= value == false ? &lsquo;#&rsquo; : &lsquo;&rsquo; %>&lt;%= key &ndash;%>&lt;%=</p>

<pre><code>     case value
     when true, false
       ''
     else
       " = #{value}"
     end
</code></pre>

<p>%>
&lt;%     end                                       &ndash;%>
&lt;%   end                                         &ndash;%></p>

<p>&lt;% end                                           &ndash;%>
```
and now the puppet define</p>

<p>``` bash override.pp
define mysql::server::config ($settings,) {</p>

<p>  file { &ldquo;/etc/mysql/conf.d/${name}.cnf&rdquo;:</p>

<pre><code>ensure  =&gt; file,
content =&gt; template('mysql/mysql.d.cnf.erb'),
owner   =&gt; 'root',
group   =&gt; 'root',
mode    =&gt; '0644',
require =&gt; Package['mysql-server'],
</code></pre>

<p>  }
```</p>

<p>and now the site.pp</p>

<p>``` bash site.pp
 mysql::server::config { &lsquo;dns_repl&rsquo;:</p>

<pre><code> settings =&gt; {
   'mysqld' =&gt; {
     'server-id'             =&gt; '5',
     'query_cache_limit'     =&gt; '5M',
     'query_cache_size'      =&gt; '128M',
     'replicate-do-db'       =&gt; [ 'dns', 'radius' ] 
    }
 }
</code></pre>

<p>  }
```
this will create a file that looks like</p>

<p><code>bash /etc/mysql/conf.d/dns_repl.cnf
   [mysqld]
   server-id = 5
   query_cache_limit = 5M
   query_cache_size = 128M
   replicate-do-db = dns
   replicate-do-db = radius
</code></p>

<p>So this is obviously awesome. Super flexible no need to define each varible you want to add into config. Just add each var to your node definition&hellip;</p>

<p>So far I have used this template style for powerdns and mysql config files but I am sure there are heaps more uses for this style of config generation.</p>

<p>Also first..!1 whoop</p>
]]></content>
  </entry>
  
</feed>
